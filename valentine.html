<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Will You Be My Valentine? üíñ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />

  <!-- CSS Files -->
  <link rel="stylesheet" href="styles/variables.css" />
  <link rel="stylesheet" href="styles/base.css" />
  <link rel="stylesheet" href="styles/layout.css" />
  <link rel="stylesheet" href="styles/components.css" />
  <link rel="stylesheet" href="styles/modals.css" />
  <link rel="stylesheet" href="styles/animations.css" />
  <link rel="stylesheet" href="styles/responsive.css" />
</head>
<body>
  <!-- Background decoration -->
  <div class="bg-overlay" id="bgOverlay">
    <div class="bg-gradient"></div>
  </div>

  <!-- Confetti / explosion layer -->
  <div class="explosion-container" id="explosionLayer"></div>

  <!-- Pages -->
  <main class="pages">
    <!-- PAGE 1 -->
    <section class="page active" id="page1" aria-label="Valentine Proposal">
      <h1 class="proposal-heading">Will you be my Valentine?</h1>
      <div class="teddy-container">
        <img src="assets/teddy_Bear.png" alt="A plush teddy bear holding a heart" class="hero-teddy" />
      </div>
      <div class="proposal-buttons">
        <button id="yesButton" class="btn btn-yes" type="button">
          ‚ù§Ô∏è Yes, forever
        </button>

        <button id="noButton" class="btn btn-no" type="button">
          <span class="btn-no-micro" id="noMicroText">Wait‚Äî!</span>
          <span id="noLabel">Umm... no?</span>
        </button>
      </div>
    </section>

    <!-- PAGE 2 -->
    <section class="page" id="page2" aria-label="Romantic Gifts">
      <button id="backToHome" class="back-btn" type="button" aria-label="Back to proposal">‚Üê Back</button>
      <div class="gifts-layout">
        <h2 class="gifts-title">Small gifts for my favorite person‚ù§Ô∏è</h2>
        <div class="gifts-grid">
          <article class="gift-card" data-gift="flowers" aria-label="Mystery gift: 1">
            <div class="gift-emoji" aria-hidden="true">üéÅ</div>
          </article>

          <article class="gift-card" data-gift="chocolate" aria-label="Mystery gift: 2">
            <div class="gift-emoji" aria-hidden="true">üéÅ</div>
          </article>

          <article class="gift-card" data-gift="countdown" aria-label="Mystery gift: 3">
            <div class="gift-emoji" aria-hidden="true">üéÅ</div>
          </article>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" id="giftModal" role="dialog" aria-modal="true">
      <button class="modal-close" id="modalClose" type="button" aria-label="Close gift message">√ó</button>
      <div class="modal-visual" id="modalVisual"></div>
      <p class="modal-message" id="modalMessage"></p>
    </div>
  </div>

  <!-- Audio elements (start only after interaction) -->
  <audio id="bgMusic" loop>
    <source src="https://www.bensound.com/bensound-music/bensound-romantic.mp3" type="audio/mpeg" />
  </audio>

  <audio id="yesSound">
    <source src="https://www.soundjay.com/button/beep-07.wav" type="audio/wav" />
  </audio>

  <audio id="unwrapSound">
    <source src="https://www.soundjay.com/button/button-3.wav" type="audio/wav" />
  </audio>

  <script>
    // --------------------------
    // BASIC REFERENCES
    // --------------------------
    const page1 = document.getElementById('page1');
    const page2 = document.getElementById('page2');
    const yesButton = document.getElementById('yesButton');
    const noButton = document.getElementById('noButton');
    const noLabel = document.getElementById('noLabel');
    const noMicroText = document.getElementById('noMicroText');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const giftModal = document.getElementById('giftModal');
    const modalClose = document.getElementById('modalClose');
    const modalVisual = document.getElementById('modalVisual');
    const modalMessage = document.getElementById('modalMessage');

    const gifts = document.querySelectorAll('.gift-card');
    const explosionLayer = document.getElementById('explosionLayer');

    const bgMusic = document.getElementById('bgMusic');
    const yesSound = document.getElementById('yesSound');
    const unwrapSound = document.getElementById('unwrapSound');

    let bgMusicEnabled = false;
    let allGiftsOpened = 0;
    let userHasInteracted = false;
    const openedOnce = {
      flowers: false,
      chocolate: false,
      countdown: false
    };
    let countdownInterval = null;

    // For "No" button mischief
    let noHoverCount = 0;
    const panicPhrases = [
      "Wait‚Äî!",
      "Hey!",
      "That was close!",
      "Are you sure?!",
      "My heartüò±",
      "Rethink this!",
      "Choose love!"
    ];

    // --------------------------
    // UTILS
    // --------------------------
    function safePlay(audioEl, volume = 1) {
      if (!audioEl) return;
      audioEl.volume = volume;
      const p = audioEl.play();
      if (p && typeof p.catch === 'function') {
        p.catch(() => {});
      }
    }

    function toggleBgMusic(forceOn) {
      if (!userHasInteracted) return;
      if (typeof forceOn === 'boolean') {
        bgMusicEnabled = forceOn;
      } else {
        bgMusicEnabled = !bgMusicEnabled;
      }

      if (bgMusicEnabled) {
        bgMusic.volume = 0.15;
        safePlay(bgMusic);
      } else {
        bgMusic.pause();
      }
    }

    function showPage(target) {
      const toPage1 = target === 1;
      if (toPage1) {
        page1.classList.add('active');
        page2.classList.remove('active');
      } else {
        page2.classList.add('active');
        page1.classList.remove('active');
      }
    }

    function createExplosion(x, y, count = 26) {
      for (let i = 0; i < count; i++) {
        const isHeart = Math.random() < 0.6;
        const particle = document.createElement('div');
        particle.className = isHeart ? 'explosion-heart' : 'explosion-confetti';

        const angle = Math.random() * Math.PI * 2;
        const speed = 80 + Math.random() * 160;
        const dx = Math.cos(angle) * speed;
        const dy = Math.sin(angle) * speed;

        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.setProperty('--dx', dx + 'px');
        particle.style.setProperty('--dy', dy + 'px');

        explosionLayer.appendChild(particle);
        particle.addEventListener('animationend', () => {
          particle.remove();
        });
      }
    }

    function stopCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    function getNextValentine() {
      const now = new Date();
      const year = now.getFullYear();
      const target = new Date(`${year}-02-14T00:00:00`);
      if (target < now) target.setFullYear(year + 1);
      return target;
    }

    function startCountdown(countEls) {
      stopCountdown();
      const target = getNextValentine();

      const update = () => {
        const now = new Date();
        const diff = Math.max(0, target - now);
        const totalSeconds = Math.floor(diff / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        countEls.days.textContent = String(days).padStart(2, '0');
        countEls.hours.textContent = String(hours).padStart(2, '0');
        countEls.minutes.textContent = String(minutes).padStart(2, '0');
        countEls.seconds.textContent = String(seconds).padStart(2, '0');
      };

      update();
      countdownInterval = setInterval(update, 1000);
    }

    function openFlowerModal() {
      stopCountdown();
      modalVisual.innerHTML = '';
      modalVisual.className = 'modal-visual';

      const voucher = document.createElement('div');
      voucher.className = 'voucher-card';

      const text = document.createElement('div');
      text.className = 'voucher-text';
      text.innerHTML = 'This voucher can be redeemed for one beautiful bouquet of flowers üíê';

      const bouquet = document.createElement('div');
      bouquet.className = 'bouquet';

      voucher.appendChild(text);
      voucher.appendChild(bouquet);

      modalVisual.appendChild(voucher);
      modalMessage.textContent = '';

      modalBackdrop.classList.add('active');
      giftModal.classList.add('active');
      modalBackdrop.setAttribute('aria-hidden', 'false');
    }

    function openChocolateModal() {
      stopCountdown();
      modalVisual.innerHTML = '';
      modalVisual.className = 'modal-visual';

      const box = document.createElement('div');
      box.className = 'choc-box';

      const cardThumb = document.querySelector('.gift-card[data-gift="chocolate"] .gift-thumb');
      let modalImg;
      if (cardThumb) {
        modalImg = cardThumb.cloneNode(true);
        modalImg.classList.remove('gift-thumb');
        modalImg.classList.add('choc-art');
      } else {
        modalImg = document.createElement('img');
        modalImg.className = 'choc-art';
        modalImg.src = './assets/chocolate_Box.png';
        modalImg.alt = 'Heart-shaped box of assorted chocolates';
      }
      modalVisual.style.height = '180px';
      box.style.display = 'flex';
      box.style.alignItems = 'center';
      box.style.justifyContent = 'center';
      modalImg.style.width = '80%';
      modalImg.style.maxWidth = '100%';
      modalImg.style.height = 'auto';
      modalImg.style.display = 'block';
      modalImg.style.margin = '0 auto 12px';
      modalImg.style.pointerEvents = 'none';
      modalImg.style.transformOrigin = 'center';
      modalImg.style.border = 'none';
      modalImg.style.background = 'transparent';
      modalImg.addEventListener('load', () => {
        console.log('Chocolate modal image loaded:', modalImg.src);
      });
      modalImg.addEventListener('error', (ev) => {
        console.error('Failed to load chocolate modal image:', modalImg.src, ev);
        const errNote = document.createElement('div');
        errNote.textContent = 'Image not available';
        errNote.style.fontSize = '0.9rem';
        errNote.style.color = 'rgba(61,6,56,0.9)';
        errNote.style.marginTop = '8px';
        box.appendChild(errNote);
      });
      box.appendChild(modalImg);

      modalVisual.appendChild(box);
      modalMessage.textContent = 'A heart full of chocolates just for you.';

      modalBackdrop.classList.add('active');
      giftModal.classList.add('active');
      modalBackdrop.setAttribute('aria-hidden', 'false');
    }

    function openCountdownModal() {
      stopCountdown();
      modalVisual.innerHTML = '';
      modalVisual.className = 'modal-visual';

      const wrapper = document.createElement('div');
      wrapper.className = 'countdown-box';

      const hearts = document.createElement('div');
      hearts.className = 'countdown-hearts';
      for (let i = 0; i < 8; i++) {
        const h = document.createElement('span');
        h.style.left = `${Math.random() * 100}%`;
        h.style.animationDelay = `${Math.random() * 3}s`;
        hearts.appendChild(h);
      }
      wrapper.appendChild(hearts);

      const grid = document.createElement('div');
      grid.className = 'countdown-grid';

      const segments = ['Days', 'Hours', 'Minutes', 'Seconds'];
      const els = {};
      segments.forEach((label) => {
        const item = document.createElement('div');
        item.className = 'countdown-item';
        const value = document.createElement('span');
        value.className = 'countdown-value';
        value.textContent = '00';
        const lbl = document.createElement('span');
        lbl.className = 'countdown-label';
        lbl.textContent = label;
        item.appendChild(value);
        item.appendChild(lbl);
        grid.appendChild(item);
        els[label.toLowerCase()] = value;
      });

      wrapper.appendChild(grid);
      modalVisual.appendChild(wrapper);

      modalMessage.textContent = 'Counting down to our Valentine\'s day‚è≥üíï';

      startCountdown(els);

      modalBackdrop.classList.add('active');
      giftModal.classList.add('active');
      modalBackdrop.setAttribute('aria-hidden', 'false');
    }

    function openModal(type) {
      if (type === 'flowers') return openFlowerModal();
      if (type === 'chocolate') return openChocolateModal();
      if (type === 'countdown') return openCountdownModal();
    }

    function closeModal() {
      giftModal.classList.remove('active');
      modalBackdrop.classList.remove('active');
      modalBackdrop.setAttribute('aria-hidden', 'true');
      stopCountdown();
      modalVisual.style.height = '';
      modalVisual.className = 'modal-visual';
    }

    // --------------------------
    // YES BUTTON
    // --------------------------
    yesButton.addEventListener('click', (ev) => {
      userHasInteracted = true;

      const rect = yesButton.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      createExplosion(centerX, centerY, 30);

      toggleBgMusic(true);
      safePlay(yesSound, 1);
      showPage(2);
    });

    // --------------------------
    // NO BUTTON
    // --------------------------
    function moveNoButton() {
      const btnRect = noButton.getBoundingClientRect();
      const margin = 10;

      const maxX = window.innerWidth - btnRect.width - margin;
      const maxY = window.innerHeight - btnRect.height - margin;

      const newX = margin + Math.random() * maxX;
      const newY = margin + Math.random() * (maxY - margin);

      const speedBase = 1.0;
      const speed = Math.max(0.35, speedBase - (noHoverCount * 0.04));
      noButton.style.position = 'fixed';
      noButton.style.transition = 'transform 0.28s ease, box-shadow 0.28s ease, left ' + speed + 's cubic-bezier(0.24, 0.9, 0.32, 1.4), top ' + speed + 's cubic-bezier(0.24, 0.9, 0.32, 1.4)';
      noButton.style.left = newX + 'px';
      noButton.style.top = newY + 'px';
    }

    noButton.addEventListener('mouseenter', () => {
      userHasInteracted = true;
      noHoverCount++;

      const phrase = panicPhrases[Math.min(noHoverCount - 1, panicPhrases.length - 1)];
      noMicroText.textContent = phrase;
      noButton.classList.add('show-micro', 'panic');
      moveNoButton();

      setTimeout(() => {
        noButton.classList.remove('panic');
      }, 250);
    });

    noButton.addEventListener('mouseleave', () => {
      noButton.classList.remove('show-micro');
    });

    // --------------------------
    // GIFTS
    // --------------------------
    gifts.forEach((gift) => {
      gift.addEventListener('click', () => {
        userHasInteracted = true;
        const type = gift.dataset.gift;
        gift.classList.add('opened');

        if (!openedOnce[type]) {
          openedOnce[type] = true;
          allGiftsOpened++;
        }

        safePlay(unwrapSound, 1);
        openModal(type);

        if (allGiftsOpened === 3) {
          const cx = window.innerWidth / 2;
          const cy = window.innerHeight / 2;
          setTimeout(() => createExplosion(cx, cy, 42), 350);
        }
      });
    });

    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) {
        closeModal();
      }
    });

    const backToHome = document.getElementById('backToHome');
    if (backToHome) {
      backToHome.addEventListener('click', () => {
        showPage(1);
      });
    }

    // --------------------------
    // CURSOR HEART TRAIL
    // --------------------------
    let lastHeartTime = 0;
    document.addEventListener('pointermove', (e) => {
      const now = performance.now();
      if (now - lastHeartTime < 45) return;
      lastHeartTime = now;

      const heart = document.createElement('div');
      heart.className = 'cursor-heart';
      const inner = document.createElement('div');
      inner.className = 'cursor-heart-inner';
      heart.appendChild(inner);

      heart.style.left = e.clientX + 'px';
      heart.style.top = e.clientY + 'px';

      document.body.appendChild(heart);
      heart.addEventListener('animationend', () => heart.remove());
    });

    // --------------------------
    // FLOATING HEARTS + SPARKLES
    // --------------------------
    const bgOverlay = document.getElementById('bgOverlay');

    function spawnBgHeart() {
      const el = document.createElement('div');
      el.className = 'bg-heart';
      const startX = Math.random() * 100;
      el.style.left = startX + 'vw';
      el.style.setProperty('--x-offset', (Math.random() * 60 - 30) + 'px');
      const duration = 10 + Math.random() * 16;
      el.style.animation = 'floatUp ' + duration + 's ease-in infinite';
      bgOverlay.appendChild(el);

      setTimeout(() => el.remove(), (duration + 1) * 1000);
    }

    function spawnSparkle() {
      const el = document.createElement('div');
      el.className = 'bg-sparkle';
      const x = Math.random() * 100;
      const y = Math.random() * 100;
      el.style.left = x + 'vw';
      el.style.top = y + 'vh';
      const duration = 2 + Math.random() * 2.5;
      el.style.animation = 'twinkle ' + duration + 's ease-in-out infinite';
      bgOverlay.appendChild(el);

      setTimeout(() => el.remove(), (duration + 0.5) * 1000);
    }

    for (let i = 0; i < 14; i++) {
      setTimeout(spawnBgHeart, i * 800);
    }

    for (let i = 0; i < 18; i++) {
      setTimeout(spawnSparkle, i * 260);
    }

    setInterval(spawnBgHeart, 4200);
    setInterval(spawnSparkle, 1900);

    // --------------------------
    // Audio interaction
    // --------------------------
    document.addEventListener('click', () => {
      userHasInteracted = true;
    }, { once: true });
  </script>
</body>
</html>
